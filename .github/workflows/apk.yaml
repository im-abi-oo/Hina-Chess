name: Hina Chess Pro APK Build

on:
  push:
    branches: [ main ]

jobs:
  twa-build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Bubblewrap
        run: npm install -g @bubblewrap/cli

      - name: Build Android APK
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          # ۱. ایجاد کلید امضا
          keytool -genkey -v -keystore android.keystore -alias android -keyalg RSA -keysize 2048 -validity 10000 \
            -storepass "$KEYSTORE_PASSWORD" -keypass "$KEY_PASSWORD" \
            -dname "CN=HinaChess, OU=Saino, O=im_abi, L=Tehran, S=Tehran, C=IR"

          # ۲. استخراج SHA-256 برای نمایش در لاگ (جهت قرار دادن در assetlinks.json)
          echo "--- YOUR SHA-256 FINGERPRINT BELOW ---"
          keytool -list -v -keystore android.keystore -alias android -storepass "$KEYSTORE_PASSWORD" | grep SHA256
          echo "--- COPY THE ABOVE CODE TO ASSETLINKS.JSON ---"

          # ۳. کانفیگ و بیلد خودکار
          mkdir twa-output
          # استفاده از حالت غیرتعاملی برای پاسخ به سوالات
          yes | bubblewrap init --manifest https://hina-chess.onrender.com/manifest.json --directory ./twa-output/ --meta
          
          cd twa-output
          bubblewrap build --signingKeyPath ../android.keystore --signingKeyAlias android \
            --signingKeyPassword "$KEY_PASSWORD" --signingStorePassword "$KEYSTORE_PASSWORD" --skipInstallCheck

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: Hina Chess
          path: twa-output/*.apk
